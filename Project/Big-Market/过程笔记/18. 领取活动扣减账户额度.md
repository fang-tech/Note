# 实现了什么

## service分层

将用户抽奖流程分成
1. 用户添加额度 
2. 领取活动 (扣减互动账户额度)
3. 执行抽奖策略
4. 抽奖结果落库

这节课主要实现的是第二个部分, 领取活动, 同时我们将原先实现的进行了分层, 以和领取活动部分进行切分
- 我们可以将这部分分成两部分
    - 创建充值订单, 为用户增加抽奖次数, 这里创建的是活动订单记录, 表明有人参与了活动, 获取了额度, 这个时候聚合对象传递的就有添加的次数
        - 这里的订单更多的是起到的记录的作用, 在数据库中记录用户获取次数额度的获取记录
        - 同时将额度的增加落库
    - 创建用户额度扣减订单, 如果用户有额度创建订单, 创建订单, 这里的订单是执行抽奖的消耗, 是一个下单记录
## 账户额度的扣减和恢复

- 在之前我们只有一个表的时候, 我们就需要在对应的时间执行恢复额度操作
- 现在我们创建了月账户表, 日账户表, 两个表分别对应了用户这个月 / 天可用的额度
- 那么在这个时候, 如果我们要执行用户账户额度的扣减
    - 将总账户, 月账户, 日账户, 三个账户中的额度都执行扣减
        - 总账户的中的镜像月余额和镜像日余额里面的值, 是我们能最多分配给这个月/日的额度, 如果这个活动有多个月, 那么下个月, 我们能分配给这个用户的月额度还需要收到总额度的限制, 总账户中的镜像额度就是为了约束这个点, 我们不能每个月都分配给用户相同的额度剩余量