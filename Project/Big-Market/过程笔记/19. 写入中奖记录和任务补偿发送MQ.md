# 为什么使用MQ发奖

> 对于用户中奖到发奖, 通常来说我们会做异步解耦

- 这里需要做异步解耦的原因是
    - 因为一些发奖的方法并不都是在抽奖系统, 而是我们需要通过各种RPC/HTTP接口来发放
    - 但是我们需要考虑我们调用这些方法出现异常的时候, 这个时候我们就需要重发
# 为什么需要任务补偿机制

> 我们需要保证写入记录和发送MQ消息(也就是调用发奖的接口执行发奖)的一致性, 保证这两个必须同时成功或者同时失败, 但是我们是无法通过数据库事务来保证这个事情, MQ消息不是数据库事务

- 引入task表, 用于记录我们需要发送的所有消息, 并在其中标记这条消息的状态
    - create : 还没有被消费
    - comleted : 这条消息已经被消费了 
    - fail : 这条消息被尝试消费过, 但是失败了

- 对于创建了但是过了很久还没有被消费的消息, 以及消费失败的消息, 我们执行定时重发
    - 我们通过定时任务, 扫描task表, 找出符合项, 执行重发