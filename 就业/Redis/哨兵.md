# 哨兵机制

## 为什么要有哨兵机制

在主从集群下, 如果主节点挂了就不能执行写操作, 这个时候就需要手动将从服务器切换成主服务器 `SLAVEOF NO ONE`
同时在从服务器中指定新的主服务器为主服务器, 同时还要通知上游的客户端, 将Redis的主服务器的IP切换成新的主服务器的IP
为了解决这个繁琐麻烦的过程, Redis通过哨兵机制, 用一个节点来检测主节点, 如果主节点挂了, 就选举从节点中的一个为新的主节点, 实现**主从故障转移**

## 哨兵机制是怎么工作的

哨兵节点主要做三件事

- 监控 : 哨兵节点节点是怎么监控节点的, 是怎么判断主节点已经故障了
- 选主 : 哨兵节点是根据什么规则选择一个新的节点作为主节点的
- 通知 : 哨兵节点是怎么把新的主节点的相关信息通知给从节点和客户端的

### 监控

> 怎么监控节点的?

哨兵节点会每隔1s向所有的主从节点发送PING命令, 节点收到PING命令以后会返回一个响应给哨兵节点

![](https://img-blog.csdnimg.cn/26f88373d8454682b9e0c1d4fd1611b4.png)

如果主从节点不响应的时间超过了`down-after-milliseconds`, 单位是毫秒, 这个哨兵节点就会将节点标记为 **\[主观下线]**
有主观下线也有客观下线, 之所以针对主节点设计主观下线和客观下线两种状态, 是因为可能主节点不响应是主节点的系统压力太大了或者网络发生了阻塞, 并不是主节点发生了阻塞
客观下线需要多个哨兵节点一起判断, (哨兵往往是集群部署的, 最少有3台), 通过多个哨兵一起判断, 能有效避免**单个哨兵节点因为自己的网络状况而误判主节点故障**
在哨兵节点标记为主观下线以后, 会向其他的哨兵发送命令, 其他的哨兵收到这个命令以后, 就会根据自己和主节点之间的连接状况投票, 如果**赞成票的数量超过quorum的配置以后, 就会判断主节点已经客观下线**, 然后哨兵节点就要从从节点之中选择下一个主节点

### 选主

