# Redis面试题

## 为什么使用Redis

### 为什么选用Redis作为MySQL数据库的缓存?

## Redis过期删除与缓存淘汰策略

### Redis使用的过期删除策略是什么?

Redis中可以为key设置过期时间, Redis中有单独的一张表用于记录每个key的过期时间

对于删除操作, Redis中有 **懒惰删除** 和 **定期删除** 两种策略

- **懒惰删除** : Redis会在下一次使用到这个key的时候, 先去检查这个key是不是再过期时间表中, 如果在并且已经过期了, 就会将这个key删除, 也就是从内存中释放
  - 优点 : 对CPU时间友好, 占用CPU的时间更少
  - 缺点 : 对缓存不友好, 没有被使用到的key会一直占用内存, 即使它已经过期了
- **定期删除** : 为了补足上面懒惰删除中某些没有被使用的过期key会一直占用内存的问题, Redis还有定期删除的设置, Redis会定期抽取一定数量的key, 并检查它们是不是过期了, 过期了就删除. 如果(过期的key / 所有检查的key) > 25%, 就会立马开启下一轮检查, 因为这个时候说明redis中有很多过期的key. 否则则等待下一轮检查. 同时为了避免这个删除循环过度, 导致线程卡死, redis中对于每一轮还有时间限制, 如果超过最大时间(默认25ms), 也会退出等待下一轮检查
  - 优点 : 能清理过期的且使用频率低的key, 对内存友好, 同时最大时间的设置, 也能限制这个操作占用过多的cpu时间
  - 缺点 : 执行的频率和时间难以把握

### Redis持久时, 对过期键会如何处理?

对于RDB(Redis Database)文件

- **RDB文件生成阶段** : 生成的时候会对key进行过期检查, 过期键不会被写入
- **RDB文件加载阶段** : 需要从主节点和从节点分情况讨论
  - **主节点** : 会进行键的过期检查, 如果键过期了, 就不会加载进Redis中
  - **从节点** : 不会检查, 会将RDB文件中的内容全部重新加载进Redis中, 但是主从节点进行数据同步时候, 从服务器中的数据会被清空, 所以从节点中的过期键也不会造成什么影响

对于AOF(Append Only)文件

- **AOF文件生成阶段 :** 如果持久化的时候, 数据库中的某个过期键还没有被删除, 就会保留这个键, 等到过期键被删除的时候, 会显式地追加一条DEL删除指令.
- **AOF文件重写阶段** : 执行AOF重写的时候, 会对Redis中键进行检查, 已经过期的键不会保存到重写后的AOF文件



### 主从模式下, Redis怎么处理过期键

从服务器不会对过期键做任何处理, 而是在主服务器会对键进行过期检查, 发现键是过期以后, 会在AOF文件中追加一条DEL指令, 同步到所有的从库, 从库通过执行这条DEL指令来删除过期键