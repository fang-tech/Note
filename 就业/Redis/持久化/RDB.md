# RDB快照

## RDB快照是怎么实现的

和AOF文件记录的是操作命令不同, RDB文件是直接记录的某一个瞬间的Redis中的内存数据, 是实际的数据

- AOF记录的是操作命令
- RDB记录的是二进制数据

因此, 在恢复数据的时候, RDB的效率高于AOF

## 快照是怎么使用的

Redis提供了两个命令来生成快照

- save命令 : 是在主进程进行的, 也就是**会阻塞主进程**
- bgsave命令 : 在后台子进程执行, **避免了阻塞主进程**

RDB的加载工作是服务器在启动的时候自动加载的, 并没有额外的命令对应

可以通过配置redis.conf文件来定时自动执行RDB快照记录, 默认会提供以下的配置

```redis
save 900 1
save 300 10
save 60 10000
```

- 900秒内, 对数据库至少进行了1次修改
- 300秒内, 对数据库至少进行了10次修改
- 60秒内, 对数据库至少进行了10000次修改

这里虽然标识的是`save`, 但是实际上执行的是`bgsave`命令

RDB是**全量快照**, 所以开销很高, 不能频繁进行, 使用RDB快照恢复, 一般来说在服务器宕机以后, 有更高的风险丢失更多的数据

## RDB和AOF合体

执行RDB的时候, 如果是在后台进程执行, 这个时候如果主进程修改了数据, 会触发**写时复制,** 这个时候主进程和bgsave后台子进程之间的数据会出现不一致, **RDB只会保留修改前的数据**

AOF和RDB各有优缺点

- AOF恢复速度更慢, 但是开销更小
- RDB恢复速度更快, 但是执行的开销更大

所以在Redis4.0以后, 给出了综合了两种方案的混合方案 : 混合使用AOF日志和内存快照, 也叫混合持久化

如果要开启这个功能, 在redis的配置文件中配置这个选项为yes

```c
aof-use-rdb-preamble yes
```

混合持久化在**AOF日志重写**的时候发生

在执行AOF日志重写的时候, 会在子进程中将和主进程共享的内容以RDB的形式存储到AOF文件中, 主线程处理的写命令会被记录在重写缓冲区中, 在之后会以AOF方式写入到AOF文件中, 写完通知主进程将新的含有RDB格式和AOF格式的AOF文件替换成旧的AOF文件

![](https://img-blog.csdnimg.cn/img_convert/f67379b60d151262753fec3b817b8617.png)